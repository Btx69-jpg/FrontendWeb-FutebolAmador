name: Build, Test e Analyze (Angular)

on:
  push:
    branches: [ master, developer ]
  pull_request: {}

jobs:
  build-test-analyze:
    name: Build, Test e Analyze
    runs-on: ubuntu-latest 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  
          
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Dependencies
        run: npm ci

      - name: Build
        run: npm run build -- --configuration=production

      - name: Test and Coverage
        run: ng test --watch=false --browsers=ChromeHeadless --code-coverage

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=LDS-Frontend-Web 

            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.spec.ts

            # 3. Caminho para o relatório de cobertura (gerado pelo 'ng test --code-coverage')
            # MUDE 'your-project-name' para o nome do seu projeto no angular.json
            -Dsonar.javascript.lcov.reportPaths=coverage/your-project-name/lcov.info

            # 4. Caminho para o relatório de testes (gerado pelo karma-junit-reporter)
            -Dsonar.junit.reportsPath=test-results.xml
            
            # 5. Caminho para o tsconfig (para análise de TypeScript)
            -Dsonar.typescript.tsconfigPath=tsconfig.json
